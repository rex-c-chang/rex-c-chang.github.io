<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS) | RC's Blog</title>
<meta name=keywords content><meta name=description content="Integrate Workload Identity in AKS In this guide, we will explore how to integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS). This integration allows AKS workloads to securely access Azure resources using managed identities, without needing to manage secrets or credentials directly within your applications.
Prerequisites Account Permission Before we get started, ensure the following:
You are logged in with the Azure CLI as a user. Your logged-in account must have sufficient permissions to create user-assigned managed identities in Azure."><meta name=author content><link rel=canonical href=https://rex-c-chang.github.io/posts/2024/03/workload-identity-aks/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5ff2630c4d1b3e25bc21f0ecd96681dbcf58219e741fa627857820b5485cb770.css integrity="sha256-X/JjDE0bPiW8IfDs2WaB289YIZ50H6YnhXggtUhct3A=" rel="preload stylesheet" as=style><link rel=icon href=https://rex-c-chang.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://rex-c-chang.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://rex-c-chang.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://rex-c-chang.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://rex-c-chang.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://rex-c-chang.github.io/posts/2024/03/workload-identity-aks/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS)"><meta property="og:description" content="Integrate Workload Identity in AKS In this guide, we will explore how to integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS). This integration allows AKS workloads to securely access Azure resources using managed identities, without needing to manage secrets or credentials directly within your applications.
Prerequisites Account Permission Before we get started, ensure the following:
You are logged in with the Azure CLI as a user. Your logged-in account must have sufficient permissions to create user-assigned managed identities in Azure."><meta property="og:type" content="article"><meta property="og:url" content="https://rex-c-chang.github.io/posts/2024/03/workload-identity-aks/"><meta property="og:image" content="https://rex-c-chang.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-12T15:50:00+08:00"><meta property="article:modified_time" content="2024-03-12T15:50:00+08:00"><meta property="og:site_name" content="RC's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rex-c-chang.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS)"><meta name=twitter:description content="Integrate Workload Identity in AKS In this guide, we will explore how to integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS). This integration allows AKS workloads to securely access Azure resources using managed identities, without needing to manage secrets or credentials directly within your applications.
Prerequisites Account Permission Before we get started, ensure the following:
You are logged in with the Azure CLI as a user. Your logged-in account must have sufficient permissions to create user-assigned managed identities in Azure."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rex-c-chang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS)","item":"https://rex-c-chang.github.io/posts/2024/03/workload-identity-aks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS)","name":"Integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS)","description":"Integrate Workload Identity in AKS In this guide, we will explore how to integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS). This integration allows AKS workloads to securely access Azure resources using managed identities, without needing to manage secrets or credentials directly within your applications.\nPrerequisites Account Permission Before we get started, ensure the following:\nYou are logged in with the Azure CLI as a user. Your logged-in account must have sufficient permissions to create user-assigned managed identities in Azure.","keywords":[],"articleBody":"Integrate Workload Identity in AKS In this guide, we will explore how to integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS). This integration allows AKS workloads to securely access Azure resources using managed identities, without needing to manage secrets or credentials directly within your applications.\nPrerequisites Account Permission Before we get started, ensure the following:\nYou are logged in with the Azure CLI as a user. Your logged-in account must have sufficient permissions to create user-assigned managed identities in Azure. Tools Azure CLI version ≥ 2.42.0 Helm 3 Managed Cluster A Kubernetes cluster with version ≥ v1.22 Components Installation OIDC The OpenID Connect metadata URL of the issuer of the identity provider that Azure AD will utilize in the token exchange protocol for validating tokens before issuing a token as the user-assigned managed identity.\nRun the command if you don’t have any cluster:\naz aks create \\ --resource-group myResourceGroup \\ --name myAKSCluster \\ --node-count 1 \\ --enable-oidc-issuer \\ --generate-ssh-keys Otherwise, update the existing cluster with the command:\naz aks update --resource-group myResourceGroup --name myAKSCluster --enable-oidc-issuer Then get your cluster’s OIDC issuer URL, which will be used later:\naz aks show --resource-group --name --query \"oidcIssuerProfile.issuerUrl\" -otsv Mutating Admission Webhook It has the following features:\nProjects a signed service account token to a well-known path. Injects authentication-related environment variables to your pods based on the annotated service account. Install by Azure CLI az aks update --resource-group myResourceGroup --name myAKSCluster --enable-workload-identity Install by Helm You can refer to this document.\nThe AKS cluster will create a workload identity controller once the above command is run.\nExport Environment Variables Now let’s check what we have:\nOIDC issuer URL Resources in AKS for Workload Identity Webhook Before going to the next steps, we should export the following environment variables:\nexport RESOURCE_GROUP=\"azwi-quickstart-$(openssl rand -hex 2)\" export USER_ASSIGNED_IDENTITY_NAME=\"\" export SERVICE_ACCOUNT_NAMESPACE=\"default\" export SERVICE_ACCOUNT_NAME=\"workload-identity-sa\" export SERVICE_ACCOUNT_ISSUER=\"\" Create a User-Assigned Managed Identity and Grant Permissions to Access Your Resources Create a managed identity which will bind with the service account:\naz identity create --name \"${USER_ASSIGNED_IDENTITY_NAME}\" --resource-group \"${RESOURCE_GROUP}\" And assign a role for it. For example, assign Azure Kubernetes Service Cluster Admin Role for this identity if you want to let a pod list cluster credentials.\nCreate a Kubernetes Service Account Create a service account for binding the managed identity:\nexport USER_ASSIGNED_IDENTITY_CLIENT_ID=\"$(az identity show --name \"${USER_ASSIGNED_IDENTITY_NAME}\" --resource-group \"${RESOURCE_GROUP}\" --query 'clientId' -otsv)\" export USER_ASSIGNED_IDENTITY_OBJECT_ID=\"$(az identity show --name \"${USER_ASSIGNED_IDENTITY_NAME}\" --resource-group \"${RESOURCE_GROUP}\" --query 'principalId' -otsv)\" cat \u003c","wordCount":"857","inLanguage":"en","image":"https://rex-c-chang.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-03-12T15:50:00+08:00","dateModified":"2024-03-12T15:50:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://rex-c-chang.github.io/posts/2024/03/workload-identity-aks/"},"publisher":{"@type":"Organization","name":"RC's Blog","logo":{"@type":"ImageObject","url":"https://rex-c-chang.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://rex-c-chang.github.io/ accesskey=h title="RC's Blog (Alt + H)">RC's Blog</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://rex-c-chang.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://rex-c-chang.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://rex-c-chang.github.io/archives/ title=Archives><span>Archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS)</h1><div class=post-meta><span title='2024-03-12 15:50:00 +0800 +0800'>March 12, 2024</span></div></header><div class=post-content><h1 id=integrate-workload-identity-in-aks>Integrate Workload Identity in AKS<a hidden class=anchor aria-hidden=true href=#integrate-workload-identity-in-aks>#</a></h1><p>In this guide, we will explore how to integrate Azure AD Workload Identity with Azure Kubernetes Service (AKS). This integration allows AKS workloads to securely access Azure resources using managed identities, without needing to manage secrets or credentials directly within your applications.</p><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><h3 id=account-permission>Account Permission<a hidden class=anchor aria-hidden=true href=#account-permission>#</a></h3><p>Before we get started, ensure the following:</p><ul><li>You are logged in with the Azure CLI as a user.</li><li>Your logged-in account must have sufficient permissions to create user-assigned managed identities in Azure.</li></ul><h3 id=tools>Tools<a hidden class=anchor aria-hidden=true href=#tools>#</a></h3><ul><li>Azure CLI version ≥ 2.42.0</li><li>Helm 3</li></ul><h3 id=managed-cluster>Managed Cluster<a hidden class=anchor aria-hidden=true href=#managed-cluster>#</a></h3><ul><li>A Kubernetes cluster with version ≥ v1.22</li></ul><h2 id=components-installation>Components Installation<a hidden class=anchor aria-hidden=true href=#components-installation>#</a></h2><h3 id=oidc>OIDC<a hidden class=anchor aria-hidden=true href=#oidc>#</a></h3><p>The OpenID Connect metadata URL of the issuer of the identity provider that Azure AD will utilize in the token exchange protocol for validating tokens before issuing a token as the user-assigned managed identity.</p><p>Run the command if you don&rsquo;t have any cluster:</p><pre tabindex=0><code class=language-azurecli data-lang=azurecli>az aks create \
    --resource-group myResourceGroup \
    --name myAKSCluster \
    --node-count 1 \
    --enable-oidc-issuer \
    --generate-ssh-keys
</code></pre><p>Otherwise, update the existing cluster with the command:</p><pre tabindex=0><code class=language-azurecli data-lang=azurecli>az aks update --resource-group myResourceGroup --name myAKSCluster --enable-oidc-issuer
</code></pre><p>Then get your cluster&rsquo;s OIDC issuer URL, which will be used later:</p><pre tabindex=0><code class=language-azurecli data-lang=azurecli>az aks show --resource-group &lt;resource_group&gt; --name &lt;cluster_name&gt; --query &#34;oidcIssuerProfile.issuerUrl&#34; -otsv
</code></pre><h3 id=mutating-admission-webhook>Mutating Admission Webhook<a hidden class=anchor aria-hidden=true href=#mutating-admission-webhook>#</a></h3><p>It has the following features:</p><ul><li>Projects a signed service account token to a well-known path.</li><li>Injects authentication-related environment variables to your pods based on the annotated service account.</li></ul><h4 id=install-by-azure-cli>Install by Azure CLI<a hidden class=anchor aria-hidden=true href=#install-by-azure-cli>#</a></h4><pre tabindex=0><code class=language-azurecli data-lang=azurecli>az aks update --resource-group myResourceGroup --name myAKSCluster --enable-workload-identity
</code></pre><h4 id=install-by-helm>Install by Helm<a hidden class=anchor aria-hidden=true href=#install-by-helm>#</a></h4><p>You can refer to this <a href=https://azure.github.io/azure-workload-identity/docs/installation/mutating-admission-webhook.html>document</a>.</p><p>The AKS cluster will create a workload identity controller once the above command is run.</p><h2 id=export-environment-variables>Export Environment Variables<a hidden class=anchor aria-hidden=true href=#export-environment-variables>#</a></h2><p>Now let&rsquo;s check what we have:</p><ul><li>OIDC issuer URL</li><li>Resources in AKS for Workload Identity Webhook</li></ul><p>Before going to the next steps, we should export the following environment variables:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>RESOURCE_GROUP</span><span class=o>=</span><span class=s2>&#34;azwi-quickstart-</span><span class=k>$(</span>openssl rand -hex 2<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USER_ASSIGNED_IDENTITY_NAME</span><span class=o>=</span><span class=s2>&#34;&lt;your user-assigned managed identity name&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SERVICE_ACCOUNT_NAMESPACE</span><span class=o>=</span><span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SERVICE_ACCOUNT_NAME</span><span class=o>=</span><span class=s2>&#34;workload-identity-sa&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SERVICE_ACCOUNT_ISSUER</span><span class=o>=</span><span class=s2>&#34;&lt;your service account issuer URL&gt;&#34;</span>
</span></span></code></pre></div><h2 id=create-a-user-assigned-managed-identity-and-grant-permissions-to-access-your-resources>Create a User-Assigned Managed Identity and Grant Permissions to Access Your Resources<a hidden class=anchor aria-hidden=true href=#create-a-user-assigned-managed-identity-and-grant-permissions-to-access-your-resources>#</a></h2><p>Create a managed identity which will bind with the service account:</p><pre tabindex=0><code class=language-azurecli data-lang=azurecli>az identity create --name &#34;${USER_ASSIGNED_IDENTITY_NAME}&#34; --resource-group &#34;${RESOURCE_GROUP}&#34;
</code></pre><p>And assign a role for it. For example, assign <strong>Azure Kubernetes Service Cluster Admin Role</strong> for this identity if you want to let a pod list cluster credentials.</p><h2 id=create-a-kubernetes-service-account>Create a Kubernetes Service Account<a hidden class=anchor aria-hidden=true href=#create-a-kubernetes-service-account>#</a></h2><p>Create a service account for binding the managed identity:</p><pre tabindex=0><code class=language-azurecli data-lang=azurecli>export USER_ASSIGNED_IDENTITY_CLIENT_ID=&#34;$(az identity show --name &#34;${USER_ASSIGNED_IDENTITY_NAME}&#34; --resource-group &#34;${RESOURCE_GROUP}&#34; --query &#39;clientId&#39; -otsv)&#34;
export USER_ASSIGNED_IDENTITY_OBJECT_ID=&#34;$(az identity show --name &#34;${USER_ASSIGNED_IDENTITY_NAME}&#34; --resource-group &#34;${RESOURCE_GROUP}&#34; --query &#39;principalId&#39; -otsv)&#34;
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl apply -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>azure.workload.identity/client-id</span><span class=p>:</span><span class=w> </span><span class=l>${USER_ASSIGNED_IDENTITY_CLIENT_ID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>${SERVICE_ACCOUNT_NAME}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>${SERVICE_ACCOUNT_NAMESPACE}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span><span class=w>
</span></span></span></code></pre></div><p>If your managed identity and service account are in <a href=https://azure.github.io/azure-workload-identity/docs/quick-start.html#5-create-a-kubernetes-service-account>different tenants</a>, you should annotate the service account to let the workload identity manager be aware of it.</p><h2 id=establish-federated-identity-credential-between-the-identity-and-the-service-account-issuer--subject>Establish Federated Identity Credential Between the Identity and the Service Account Issuer & Subject<a hidden class=anchor aria-hidden=true href=#establish-federated-identity-credential-between-the-identity-and-the-service-account-issuer--subject>#</a></h2><p>Binding the service account and managed identity:</p><pre tabindex=0><code class=language-azurecli data-lang=azurecli>az identity federated-credential create \
  --name &#34;kubernetes-federated-credential&#34; \
  --identity-name &#34;${USER_ASSIGNED_IDENTITY_NAME}&#34; \
  --resource-group &#34;${RESOURCE_GROUP}&#34; \
  --issuer &#34;${SERVICE_ACCOUNT_ISSUER}&#34; \
  --subject &#34;system:serviceaccount:${SERVICE_ACCOUNT_NAMESPACE}:${SERVICE_ACCOUNT_NAME}&#34;
</code></pre><h2 id=deploy-workload>Deploy Workload<a hidden class=anchor aria-hidden=true href=#deploy-workload>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl apply -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>quick-start</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>${SERVICE_ACCOUNT_NAMESPACE}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>azure.workload.identity/use</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>${SERVICE_ACCOUNT_NAME}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mcr.microsoft.com/azure-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oidc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;tail&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-f&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;/dev/null&#34;</span><span class=p>]</span><span class=w>  </span><span class=c># Run tail -f /dev/null to keep the container running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;256Mi&#34;</span><span class=w>   </span><span class=c># Request 256 MiB of memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;100m&#34;</span><span class=w>       </span><span class=c># Request 100 millicpu (0.1 CPU core)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>   </span><span class=c># Limit to 512 MiB of memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>       </span><span class=c># Limit to 500 millicpu (0.5 CPU core)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/os</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span><span class=w>
</span></span></span></code></pre></div><p>You will see <strong>AZURE_AUTHORITY_HOST</strong>, <strong>AZURE_CLIENT_ID</strong>, <strong>AZURE_TENANT_ID</strong>, and <strong>AZURE_FEDERATED_TOKEN_FILE</strong> have been injected into quick-start. Refer to <a href=https://azure.github.io/azure-workload-identity/docs/quick-start.html#7-deploy-workload>the doc</a> to know the meaning of each attribute.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pod quick-start
</span></span></code></pre></div><h2 id=verification>Verification<a hidden class=anchor aria-hidden=true href=#verification>#</a></h2><p>You can attach to the Pod quick-start and execute the following command:</p><pre tabindex=0><code class=language-azurecli data-lang=azurecli>az login --service-principal --tenant $AZURE_TENANT_ID --federated-token &#34;$(cat ${AZURE_FEDERATED_TOKEN_FILE})&#34; -u $AZURE_CLIENT_ID
</code></pre><p>We can also use an init container to get credentials in the beginning and use them later:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl apply -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>quick-start</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>${SERVICE_ACCOUNT_NAMESPACE}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>azure.workload.identity/use</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>${SERVICE_ACCOUNT_NAME}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>azure-login</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mcr.microsoft.com/azure-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 1. It should add escape symbol because environment variables should not be interpolated by the current shell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 2. It should ensure ACL for kube config or it will throw permission error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          az login --service-principal --tenant \$AZURE_TENANT_ID --federated-token &#34;\$(cat \$AZURE_FEDERATED_TOKEN_FILE)&#34; -u \$AZURE_CLIENT_ID &amp;&amp; \
</span></span></span><span class=line><span class=cl><span class=sd>          az aks get-credentials --resource-group myResourceGroup --name myAKSCluster --admin --file /custom/.kube/config &amp;&amp; \
</span></span></span><span class=line><span class=cl><span class=sd>          addgroup -S myUser &amp;&amp; \
</span></span></span><span class=line><span class=cl><span class=sd>          adduser -S myUser -G myUser &amp;&amp; \
</span></span></span><span class=line><span class=cl><span class=sd>          chown myUser /custom/.kube/config</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aks-credentials</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;256Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;200m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;256Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;200m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>my-workload:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Workload</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;tail&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-f&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;/dev/null&#34;</span><span class=p>]</span><span class=w>  </span><span class=c># Keep the container running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aks-credentials</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>KUBECONFIG</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/custom/.kube/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aks-credentials</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/os</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span><span class=w>
</span></span></span></code></pre></div><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://azure.github.io/azure-workload-identity/docs/quick-start.html>Azure AD Workload Identity</a></li><li><a href=https://learn.microsoft.com/en-us/azure/aks/workload-identity-deploy-cluster#create-a-managed-identity-and-grant-permissions-to-access-the-secret>Deploy and Configure Workload Identity on an Azure Kubernetes Service (AKS) Cluster</a></li><li><a href=https://www.jannemattila.com/azure/2024/05/13/arc-enabled-kubernetes-and-entra-workload-id.html>Arc-enabled Kubernetes and Microsoft Entra Workload ID</a></li><li><a href="https://www.youtube.com/watch?v=i2GobU0Wg48">AKS Workload Identity - Quick Tutorial</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://rex-c-chang.github.io/posts/2024/01/hello-world/><span class=title>Next »</span><br><span>Hello World</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://rex-c-chang.github.io/>RC's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>